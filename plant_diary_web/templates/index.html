<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¤ç‰©æ—¥è¨˜ - Web ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif;
            background: #f5f5f5;
            padding: 10px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        header {
            background: #4CAF50;
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .header-content {
            text-align: center;
            flex: 1;
        }
        
        h1 {
            font-size: 32px;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .subtitle {
            font-size: 18px;
            opacity: 0.95;
        }
        
        .main-content {
            background: white;
            padding: 20px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            background: #45a049;
        }
        
        .btn-secondary {
            background: #2196F3;
        }
        
        .btn-secondary:hover {
            background: #0b7dda;
        }
        
        .btn-danger {
            background: #f44336;
        }
        
        .btn-danger:hover {
            background: #da190b;
        }
        
        .search-container {
            margin-bottom: 20px;
            position: relative;
        }
        
        .search-box {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }
        
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 18px;
            pointer-events: none;
        }
        
        .plant-list {
            margin-top: 20px;
            display: grid;
            gap: 15px;
        }
        
        .plant-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
        }
        
        .plant-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #4CAF50;
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        
        .plant-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #4CAF50;
        }
        
        .plant-item:hover::before {
            transform: scaleY(1);
        }
        
        .plant-item-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .plant-item-main {
            flex: 1;
        }
        
        .plant-name {
            font-size: 20px;
            font-weight: 600;
            color: #212121;
            margin-bottom: 6px;
            line-height: 1.4;
        }
        
        .plant-scientific {
            font-size: 14px;
            color: #757575;
            font-style: italic;
            margin-bottom: 12px;
        }
        
        .plant-meta {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #f0f0f0;
        }
        
        .plant-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #666;
        }
        
        .plant-meta-item .icon {
            font-size: 16px;
        }
        
        .photo-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            height: 24px;
            padding: 0 8px;
            background: #e8f5e9;
            color: #2e7d32;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-state-text {
            font-size: 18px;
            margin-bottom: 10px;
            color: #666;
        }
        
        .empty-state-hint {
            font-size: 14px;
            color: #999;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        
        .modal-content {
            background: white;
            margin: 20px auto;
            padding: 24px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .close {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
        }
        
        .close:hover {
            color: #000;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        input[type="text"],
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .photo-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }
        
        .photo-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .photo-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .photo-item-header {
            position: relative;
            background: #f5f5f5;
            overflow: hidden;
            cursor: pointer;
        }
        
        .photo-item img {
            width: 100%;
            height: 250px;
            object-fit: cover;
            display: block;
            transition: transform 0.3s ease;
            background: #f9f9f9;
        }
        
        .photo-item:hover img {
            transform: scale(1.05);
        }
        
        .photo-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0);
            transition: background 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .photo-item:hover .photo-overlay {
            background: rgba(0,0,0,0.3);
        }
        
        .photo-overlay-icon {
            opacity: 0;
            color: white;
            font-size: 32px;
            transition: opacity 0.3s ease;
        }
        
        .photo-item:hover .photo-overlay-icon {
            opacity: 1;
        }
        
        .photo-checkbox {
            position: absolute;
            top: 12px;
            left: 12px;
            width: 28px;
            height: 28px;
            z-index: 15;
            cursor: pointer;
            accent-color: #2196F3;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .photo-delete-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(244, 67, 54, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            font-size: 20px;
            line-height: 1;
            z-index: 15;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .photo-delete-btn:hover {
            background: rgba(211, 47, 47, 1);
            transform: scale(1.1);
        }
        
        .photo-content {
            padding: 16px;
        }
        
        .photo-date {
            padding: 10px 16px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
            font-size: 13px;
            color: #666;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .photo-notes {
            padding: 10px 16px;
            background: #fff;
            border-top: 1px solid #eee;
            font-size: 13px;
            color: #666;
        }
        
        .photo-analysis {
            padding: 16px;
            background: #f9f9f9;
            border-top: 1px solid #eee;
        }
        
        .photo-analysis-section {
            margin-bottom: 16px;
        }
        
        .photo-analysis-section:last-child {
            margin-bottom: 0;
        }
        
        .photo-analysis-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .photo-analysis-title.ai {
            color: #2e7d32;
        }
        
        .photo-analysis-title.suggestion {
            color: #1976d2;
        }
        
        .photo-analysis-content {
            font-size: 14px;
            color: #333;
            line-height: 1.7;
            word-wrap: break-word;
        }
        
        .photo-analysis-pending {
            padding: 12px 16px;
            background: #fff3cd;
            border-top: 1px solid #eee;
            font-size: 12px;
            color: #856404;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* ç…§ç‰‡æ”¾å¤§æŸ¥çœ‹ï¼ˆLightboxï¼‰ */
        .lightbox {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            overflow: hidden;
        }
        
        .lightbox.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .lightbox-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            margin: auto;
        }
        
        .lightbox-image {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }
        
        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 2001;
            background: rgba(0,0,0,0.5);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        
        .lightbox-close:hover {
            background: rgba(0,0,0,0.8);
        }
        
        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            z-index: 2001;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        
        .lightbox-nav:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .lightbox-prev {
            left: 20px;
        }
        
        .lightbox-next {
            right: 20px;
        }
        
        .photo-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #999;
            font-size: 14px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 600px) {
            .modal-content {
                width: 95%;
                margin: 10px auto;
            }
            
            header {
                align-items: center;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .header-content {
                text-align: center;
                width: 100%;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .subtitle {
                font-size: 16px;
            }
            
            .plant-item {
                padding: 16px;
            }
            
            .plant-name {
                font-size: 18px;
            }
            
            .plant-meta {
                gap: 12px;
            }
            
            .photo-grid {
                grid-template-columns: 1fr;
            }
            
            .lightbox-close {
                top: 10px;
                right: 10px;
                width: 40px;
                height: 40px;
                font-size: 32px;
            }
            
            .lightbox-nav {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }
            
            .lightbox-prev {
                left: 10px;
            }
            
            .lightbox-next {
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1>ğŸŒ± æ¤ç‰©æ—¥è¨˜</h1>
                <div class="subtitle">æ¤ç‰©æˆé•·è¨˜éŒ„èˆ‡ç®¡ç†</div>
            </div>
            <div style="margin-left: auto;">
                <span id="userInfo" style="margin-right: 15px; font-size: 14px;"></span>
                <button class="btn" onclick="logout()" style="padding: 8px 16px; font-size: 14px;">ç™»å‡º</button>
            </div>
        </header>
        
        <div class="main-content">
            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="btn" onclick="showAddPlantModal()" style="flex: 1; min-width: 150px;">+ æ·»åŠ æ–°æ¤ç‰©</button>
                <button class="btn btn-secondary" onclick="loadPlants()" style="flex: 0 0 auto;">ğŸ”„ åˆ·æ–°</button>
            </div>
            
            <div class="search-container">
                <input type="text" 
                       id="searchInput" 
                       class="search-box" 
                       placeholder="æœç´¢æ¤ç‰©åç¨±æˆ–å­¸å..."
                       oninput="filterPlants()">
                <span class="search-icon">ğŸ”</span>
            </div>
            
            <div class="plant-list" id="plantList">
                <div class="loading">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>
    
    <!-- æ·»åŠ æ¤ç‰©æ¨¡æ…‹æ¡† -->
    <div id="addPlantModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addPlantModal')">&times;</span>
            <h2>æ·»åŠ æ–°æ¤ç‰©</h2>
            
            <button class="btn btn-secondary" onclick="showOCRModal()" style="margin-bottom: 15px;">
                ğŸ“· å¾ç…§ç‰‡è­˜åˆ¥
            </button>
            
            <form id="addPlantForm">
                <div class="form-group">
                    <label>ä¸­æ–‡åç¨± *</label>
                    <input type="text" id="chineseName" required>
                </div>
                
                <div class="form-group">
                    <label>å­¸å</label>
                    <input type="text" id="scientificName">
                </div>
                
                <div class="form-group">
                    <label>å‚™è¨»</label>
                    <textarea id="notes"></textarea>
                </div>
                
                <button type="submit" class="btn">ä¿å­˜</button>
                <button type="button" class="btn btn-danger" onclick="closeModal('addPlantModal')">å–æ¶ˆ</button>
            </form>
        </div>
    </div>
    
    <!-- OCR è­˜åˆ¥æ¨¡æ…‹æ¡† -->
    <div id="ocrModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('ocrModal')">&times;</span>
            <h2>å¾ç…§ç‰‡è­˜åˆ¥</h2>
            
            <div class="form-group">
                <label>é¸æ“‡æ¤ç‰©èŠ±ç‰Œç…§ç‰‡</label>
                <input type="file" id="ocrPhoto" accept="image/*" capture="environment">
            </div>
            
            <button class="btn" onclick="recognizePhoto()">é–‹å§‹è­˜åˆ¥</button>
            <div id="ocrResult" style="margin-top: 15px;"></div>
        </div>
    </div>
    
    <!-- æ¤ç‰©è©³æƒ…æ¨¡æ…‹æ¡† -->
    <div id="plantDetailModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" onclick="closeModal('plantDetailModal')">&times;</span>
            <h2 id="detailPlantName"></h2>
            <p id="detailScientificName" style="color: #666; margin-bottom: 20px;"></p>
            
            <div class="form-group">
                <label>ä¸Šå‚³ç…§ç‰‡</label>
                <input type="file" id="plantPhoto" accept="image/*">
                <textarea id="photoNotes" placeholder="ç…§ç‰‡å‚™è¨»ï¼ˆå¯é¸ï¼‰" style="margin-top: 10px;"></textarea>
                <button class="btn" onclick="uploadPhoto()" style="margin-top: 10px;">ä¸Šå‚³ç…§ç‰‡</button>
            </div>
            
            <div id="analyzeButtonContainer" style="margin: 20px 0; display: none;">
                <button class="btn" onclick="analyzeSelectedPhotos()" style="background: #2196F3; color: white;">
                    ğŸ¤– AI åˆ†æé¸ä¸­çš„ç…§ç‰‡
                </button>
                <span id="selectedCount" style="margin-left: 10px; color: #666; font-size: 14px;"></span>
            </div>
            
            <h3 style="margin-top: 20px; margin-bottom: 16px;">æˆé•·æ­·ç¨‹</h3>
            <div class="photo-grid" id="photoGrid"></div>
        </div>
    </div>
    
    <!-- ç…§ç‰‡æ”¾å¤§æŸ¥çœ‹ï¼ˆLightboxï¼‰ -->
    <div id="lightbox" class="lightbox" onclick="closeLightbox(event)">
        <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
        <button class="lightbox-nav lightbox-prev" onclick="changeLightboxPhoto(-1, event)">â€¹</button>
        <button class="lightbox-nav lightbox-next" onclick="changeLightboxPhoto(1, event)">â€º</button>
        <div class="lightbox-content" onclick="event.stopPropagation()">
            <img id="lightboxImage" class="lightbox-image" src="" alt="ç…§ç‰‡">
        </div>
    </div>
    
    <script>
        let currentPlantId = null;
        let currentUser = null;
        
        // è¼‰å…¥ç•¶å‰ç”¨æˆ¶ä¿¡æ¯
        async function loadCurrentUser() {
            try {
                const response = await fetch('/api/user/current');
                const result = await response.json();
                if (result.success) {
                    currentUser = result.user;
                    updateUserInfo();
                } else {
                    // æœªç™»å…¥ï¼Œè·³è½‰åˆ°ç™»å…¥é é¢
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('è¼‰å…¥ç”¨æˆ¶ä¿¡æ¯å¤±æ•—:', error);
                window.location.href = '/login';
            }
        }
        
        // æ›´æ–°ç”¨æˆ¶ä¿¡æ¯é¡¯ç¤º
        function updateUserInfo() {
            const userInfoDiv = document.getElementById('userInfo');
            if (currentUser && userInfoDiv) {
                let info = `æ­¡è¿ï¼Œ${currentUser.username}`;
                if (currentUser.is_admin) {
                    info += ' (ç®¡ç†å“¡)';
                }
                userInfoDiv.textContent = info;
            }
        }
        
        // ç™»å‡º
        async function logout() {
            if (!confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch('/logout', {
                    method: 'POST'
                });
                
                const result = await response.json();
                if (result.success) {
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('ç™»å‡ºå¤±æ•—:', error);
            }
        }
        
        // é é¢è¼‰å…¥æ™‚ç²å–ç”¨æˆ¶ä¿¡æ¯
        loadCurrentUser();
        
        // HTMLè½‰ç¾©å‡½æ•¸ï¼Œé˜²æ­¢XSSæ”»æ“Šä¸¦æ­£ç¢ºé¡¯ç¤ºæ–‡æœ¬
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // æ ¼å¼åŒ–ç…§é¡§å»ºè­°æ–‡æœ¬ï¼Œæ”¹å–„æ’ç‰ˆ
        function formatCareSuggestions(text) {
            if (!text) return '';
            
            // HTMLè½‰ç¾©
            let formatted = escapeHtml(text);
            
            // å°‡å¤šå€‹é€£çºŒç©ºæ ¼/è£½è¡¨ç¬¦è½‰æ›ç‚ºå–®å€‹ç©ºæ ¼
            formatted = formatted.replace(/[ \t]+/g, ' ');
            
            // è™•ç†Markdownæ ¼å¼çš„ç²—é«”ï¼ˆ**æ–‡å­—**ï¼‰
            formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // å°‡æ–‡æœ¬æŒ‰æ›è¡Œç¬¦åˆ†å‰²
            const lines = formatted.split('\n').map(line => line.trim()).filter(line => line);
            
            if (lines.length === 0) return '';
            
            // å°‡æ¯è¡Œè½‰æ›ç‚ºæ®µè½ï¼Œè®“æ–‡æœ¬åœ¨æ®µè½å…§è‡ªç„¶æµå‹•ï¼ˆä¸å¼·åˆ¶æ›è¡Œï¼‰
            return lines.map((line, index) => {
                // åˆ—è¡¨é …ï¼ˆä»¥æ•¸å­—é–‹é ­ï¼Œå¾Œé¢è·Ÿè‘—é»å’Œç©ºæ ¼ï¼‰
                if (/^\d+\.\s/.test(line)) {
                    return `<div style="margin-bottom: 10px; line-height: 1.8; text-align: left;">${line}</div>`;
                } else {
                    // æ™®é€šæ–‡æœ¬æ®µè½
                    return `<div style="margin-bottom: ${index < lines.length - 1 ? '10px' : '0'}; line-height: 1.8; text-align: left;">${line}</div>`;
                }
            }).join('');
        }
        
        let allPlants = []; // å­˜å„²æ‰€æœ‰æ¤ç‰©æ•¸æ“šï¼Œç”¨æ–¼æœç´¢éæ¿¾
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                const now = new Date();
                const diffTime = Math.abs(now - date);
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) {
                    return 'ä»Šå¤©';
                } else if (diffDays === 1) {
                    return 'æ˜¨å¤©';
                } else if (diffDays < 7) {
                    return `${diffDays}å¤©å‰`;
                } else if (diffDays < 30) {
                    const weeks = Math.floor(diffDays / 7);
                    return `${weeks}é€±å‰`;
                } else {
                    return date.toLocaleDateString('zh-TW', { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric' 
                    });
                }
            } catch (e) {
                return '';
            }
        }
        
        // è¼‰å…¥æ¤ç‰©åˆ—è¡¨
        async function loadPlants() {
            try {
                const plantList = document.getElementById('plantList');
                plantList.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
                
                const response = await fetch('/api/plants');
                const plants = await response.json();
                
                allPlants = plants; // ä¿å­˜æ‰€æœ‰æ¤ç‰©ç”¨æ–¼æœç´¢
                
                if (plants.length === 0) {
                    plantList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸŒ±</div>
                            <div class="empty-state-text">é‚„æ²’æœ‰æ·»åŠ æ¤ç‰©</div>
                            <div class="empty-state-hint">é»æ“Šä¸Šæ–¹ã€Œ+ æ·»åŠ æ–°æ¤ç‰©ã€æŒ‰éˆ•é–‹å§‹è¨˜éŒ„æ‚¨çš„æ¤ç‰©å§ï¼</div>
                        </div>
                    `;
                    return;
                }
                
                renderPlants(plants);
            } catch (error) {
                const plantList = document.getElementById('plantList');
                plantList.innerHTML = `<div style="text-align: center; padding: 40px; color: #f44336;">
                    <div style="font-size: 48px; margin-bottom: 16px;">âš ï¸</div>
                    <div>è¼‰å…¥æ¤ç‰©åˆ—è¡¨å¤±æ•—</div>
                    <div style="font-size: 14px; color: #999; margin-top: 8px;">${error.message}</div>
                </div>`;
            }
        }
        
        // æ¸²æŸ“æ¤ç‰©åˆ—è¡¨
        function renderPlants(plants) {
            const plantList = document.getElementById('plantList');
            
            if (plants.length === 0) {
                plantList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ”</div>
                        <div class="empty-state-text">æ²’æœ‰æ‰¾åˆ°åŒ¹é…çš„æ¤ç‰©</div>
                        <div class="empty-state-hint">å˜—è©¦ä½¿ç”¨ä¸åŒçš„é—œéµè©æœç´¢</div>
                    </div>
                `;
                return;
            }
            
            plantList.innerHTML = plants.map(plant => {
                const photoCount = plant.photo_count || 0;
                const createdDate = formatDate(plant.created_at);
                
                return `
                    <div class="plant-item" onclick="showPlantDetail(${plant.id})">
                        <div class="plant-item-header">
                            <div class="plant-item-main">
                                <div class="plant-name">${escapeHtml(plant.chinese_name)}</div>
                                ${plant.scientific_name ? `<div class="plant-scientific">${escapeHtml(plant.scientific_name)}</div>` : ''}
                            </div>
                        </div>
                        <div class="plant-meta">
                            <div class="plant-meta-item">
                                <span class="icon">ğŸ“·</span>
                                <span class="photo-count">${photoCount}</span>
                                <span>å¼µç…§ç‰‡</span>
                            </div>
                            ${createdDate ? `
                                <div class="plant-meta-item">
                                    <span class="icon">ğŸ“…</span>
                                    <span>${createdDate}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // æœç´¢éæ¿¾æ¤ç‰©
        function filterPlants() {
            const searchInput = document.getElementById('searchInput');
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (!searchTerm) {
                renderPlants(allPlants);
                return;
            }
            
            const filtered = allPlants.filter(plant => {
                const chineseName = (plant.chinese_name || '').toLowerCase();
                const scientificName = (plant.scientific_name || '').toLowerCase();
                return chineseName.includes(searchTerm) || scientificName.includes(searchTerm);
            });
            
            renderPlants(filtered);
        }
        
        // é¡¯ç¤ºæ·»åŠ æ¤ç‰©æ¨¡æ…‹æ¡†
        function showAddPlantModal() {
            document.getElementById('addPlantModal').style.display = 'block';
            document.getElementById('addPlantForm').reset();
        }
        
        // é¡¯ç¤º OCR è­˜åˆ¥æ¨¡æ…‹æ¡†
        function showOCRModal() {
            document.getElementById('ocrModal').style.display = 'block';
            document.getElementById('ocrResult').innerHTML = '';
        }
        
        // é—œé–‰æ¨¡æ…‹æ¡†
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // å¡«å…¥æ¬„ä½ï¼ˆå¾ Base64 ç·¨ç¢¼çš„å­—ç¬¦ä¸²è§£ç¢¼ï¼‰
        function fillFieldFromEncoded(fieldId, encodedValue) {
            try {
                const decodedValue = decodeURIComponent(escape(atob(encodedValue)));
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = decodedValue;
                    field.dispatchEvent(new Event('input', { bubbles: true }));
                    
                    // ç¢ºä¿æ·»åŠ æ¤ç‰©æ¨¡æ…‹æ¡†æ˜¯æ‰“é–‹çš„
                    const addPlantModal = document.getElementById('addPlantModal');
                    if (addPlantModal.style.display !== 'block') {
                        addPlantModal.style.display = 'block';
                    }
                    
                    // å¯é¸ï¼šé—œé–‰ OCR æ¨¡æ…‹æ¡†
                    // closeModal('ocrModal');
                }
            } catch (error) {
                console.error('è§£ç¢¼éŒ¯èª¤:', error);
                alert('å¡«å…¥æ¬„ä½æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æ‰‹å‹•è¼¸å…¥');
            }
        }
        
        // å¡«å…¥æ¬„ä½ï¼ˆç›´æ¥å‚³å€¼ï¼Œç”¨æ–¼å…§éƒ¨èª¿ç”¨ï¼‰
        function fillField(fieldId, value) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.value = value;
                field.dispatchEvent(new Event('input', { bubbles: true }));
                
                // ç¢ºä¿æ·»åŠ æ¤ç‰©æ¨¡æ…‹æ¡†æ˜¯æ‰“é–‹çš„
                const addPlantModal = document.getElementById('addPlantModal');
                if (addPlantModal.style.display !== 'block') {
                    addPlantModal.style.display = 'block';
                }
            }
        }
        
        // OCR è­˜åˆ¥
        async function recognizePhoto() {
            const fileInput = document.getElementById('ocrPhoto');
            if (!fileInput.files || !fileInput.files[0]) {
                alert('è«‹é¸æ“‡ç…§ç‰‡');
                return;
            }
            
            const formData = new FormData();
            formData.append('photo', fileInput.files[0]);
            
            const resultDiv = document.getElementById('ocrResult');
            resultDiv.innerHTML = '<div class="loading">è­˜åˆ¥ä¸­...</div>';
            
            try {
                const response = await fetch('/api/ocr/recognize', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                // èª¿è©¦ä¿¡æ¯ï¼ˆå¯ä»¥åœ¨æ§åˆ¶å°æŸ¥çœ‹ï¼‰
                console.log('OCRè­˜åˆ¥çµæœ:', result);
                console.log('åŸå§‹æ–‡æœ¬:', result.raw_text);
                console.log('æ˜¯å¦æœ‰åŸå§‹æ–‡æœ¬:', !!result.raw_text);
                
                if (result.success) {
                    // å¡«å……è¡¨å–®ï¼ˆç¢ºä¿æ·»åŠ æ¤ç‰©æ¨¡æ…‹æ¡†æ˜¯æ‰“é–‹çš„ï¼‰
                    const chineseName = result.chinese_name || '';
                    const scientificName = result.scientific_name || '';
                    
                    // ç¢ºä¿æ·»åŠ æ¤ç‰©æ¨¡æ…‹æ¡†æ˜¯æ‰“é–‹çš„
                    const addPlantModal = document.getElementById('addPlantModal');
                    if (addPlantModal.style.display !== 'block') {
                        addPlantModal.style.display = 'block';
                    }
                    
                    // å¡«å……è¡¨å–®å­—æ®µ
                    const chineseNameInput = document.getElementById('chineseName');
                    const scientificNameInput = document.getElementById('scientificName');
                    
                    if (chineseNameInput) {
                        chineseNameInput.value = chineseName;
                        // è§¸ç™¼è¼¸å…¥äº‹ä»¶ä»¥ç¢ºä¿å€¼è¢«è¨­ç½®
                        chineseNameInput.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                    
                    if (scientificNameInput) {
                        scientificNameInput.value = scientificName;
                        scientificNameInput.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                    
                    // é¡¯ç¤ºè­˜åˆ¥çµæœ
                    let resultHtml = `
                        <div style="background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                            <strong>è­˜åˆ¥å®Œæˆ</strong><br>
                            ä¸­æ–‡åç¨±: ${chineseName || '<span style="color: #856404;">æœªè­˜åˆ¥</span>'}<br>
                            å­¸å: ${scientificName || '<span style="color: #856404;">æœªè­˜åˆ¥</span>'}
                        </div>
                    `;
                    
                    // å§‹çµ‚é¡¯ç¤ºåŸå§‹æ–‡æœ¬ï¼ˆç”¨æ–¼èª¿è©¦å’Œæ‰‹å‹•è¼¸å…¥ï¼‰
                    const rawText = result.raw_text || '';
                    console.log('æº–å‚™é¡¯ç¤ºçš„åŸå§‹æ–‡æœ¬:', rawText);
                    
                    if (rawText && rawText.trim().length > 0) {
                        // å°‡åŸå§‹æ–‡æœ¬æŒ‰è¡Œåˆ†å‰²ï¼Œæ¯è¡Œæä¾›é¸æ“‡æŒ‰éˆ•
                        const textLines = rawText.toString().split('\n').filter(line => line.trim().length > 0);
                        let textItemsHtml = '';
                        
                        textLines.forEach((line, index) => {
                            // å®‰å…¨åœ°è½‰ç¾© HTML å’Œ JavaScript
                            const escapedLine = line.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                            // ä½¿ç”¨ Base64 ç·¨ç¢¼ä¾†å®‰å…¨å‚³éæ–‡æœ¬å€¼ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦å•é¡Œ
                            const encodedLine = btoa(unescape(encodeURIComponent(line)));
                            textItemsHtml += `
                                <div style="display: flex; align-items: center; gap: 8px; padding: 6px; margin-bottom: 4px; background: #f8f9fa; border-radius: 4px; border: 1px solid #e0e0e0;">
                                    <span style="flex: 1; font-family: 'Courier New', monospace; font-size: 13px; word-break: break-all;">${escapedLine}</span>
                                    <button onclick="fillFieldFromEncoded('chineseName', '${encodedLine}')" style="background: #4CAF50; color: white; border: none; padding: 4px 10px; border-radius: 3px; cursor: pointer; font-size: 11px; white-space: nowrap;">å¡«å…¥ä¸­æ–‡å</button>
                                    <button onclick="fillFieldFromEncoded('scientificName', '${encodedLine}')" style="background: #2196F3; color: white; border: none; padding: 4px 10px; border-radius: 3px; cursor: pointer; font-size: 11px; white-space: nowrap;">å¡«å…¥å­¸å</button>
                                </div>
                            `;
                        });
                        
                        resultHtml += `
                            <div style="background: #e7f3ff; color: #004085; padding: 10px; border-radius: 5px; font-size: 12px; margin-top: 10px; border-left: 3px solid #2196F3;">
                                <strong>ğŸ“ è­˜åˆ¥åˆ°çš„åŸå§‹æ–‡æœ¬ï¼š</strong><br>
                                <div style="margin-top: 8px; max-height: 300px; overflow-y: auto;">
${textItemsHtml}
                                </div>
                                <div style="margin-top: 8px; color: #004085; font-size: 11px;">
                                    <small>ğŸ’¡ é»æ“ŠæŒ‰éˆ•å°‡æ–‡å­—å¡«å…¥å°æ‡‰æ¬„ä½</small>
                                </div>
                            </div>
                        `;
                    } else {
                        // å¦‚æœæ²’æœ‰åŸå§‹æ–‡æœ¬ï¼Œä¹Ÿé¡¯ç¤ºæç¤º
                        resultHtml += `
                            <div style="background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; font-size: 12px; margin-top: 10px;">
                                <small>âš ï¸ æœªè­˜åˆ¥åˆ°ä»»ä½•æ–‡å­—ï¼ˆåŸå§‹æ–‡æœ¬ç‚ºç©ºï¼‰ï¼Œè«‹æª¢æŸ¥ç…§ç‰‡æ¸…æ™°åº¦æˆ–é‡è©¦</small>
                                <br><small style="color: #666;">èª¿è©¦ä¿¡æ¯: raw_text = "${rawText}"</small>
                            </div>
                        `;
                    }
                    
                    // çµ±ä¸€è¨­ç½®çµæœHTML
                    resultDiv.innerHTML = resultHtml;
                    
                    // å¦‚æœè­˜åˆ¥åˆ°å…§å®¹ï¼Œå»¶é²é—œé–‰ OCR æ¨¡æ…‹æ¡†
                    if (chineseName || scientificName) {
                        // å»¶é²é—œé–‰ï¼Œè®“ç”¨æˆ¶çœ‹åˆ°çµæœ
                        setTimeout(() => {
                            closeModal('ocrModal');
                            // ç¢ºä¿æ·»åŠ æ¤ç‰©æ¨¡æ…‹æ¡†ä»ç„¶æ‰“é–‹
                            addPlantModal.style.display = 'block';
                        }, 2000);
                    }
                    // å¦‚æœæ²’æœ‰è­˜åˆ¥åˆ°å…§å®¹ï¼Œä¿æŒæ¨¡æ…‹æ¡†æ‰“é–‹ï¼Œè®“ç”¨æˆ¶æŸ¥çœ‹åŸå§‹æ–‡æœ¬
                } else {
                    resultDiv.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px;">
                        è­˜åˆ¥å¤±æ•—: ${result.error || 'æœªçŸ¥éŒ¯èª¤'}
                    </div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px;">
                    è­˜åˆ¥å‡ºéŒ¯: ${error.message}
                </div>`;
            }
        }
        
        // æäº¤æ·»åŠ æ¤ç‰©è¡¨å–®
        document.getElementById('addPlantForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                chinese_name: document.getElementById('chineseName').value,
                scientific_name: document.getElementById('scientificName').value,
                notes: document.getElementById('notes').value
            };
            
            try {
                const response = await fetch('/api/plants', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('æ¤ç‰©å·²æ·»åŠ ï¼');
                    closeModal('addPlantModal');
                    loadPlants();
                } else {
                    alert('æ·»åŠ å¤±æ•—: ' + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                alert('æ·»åŠ å¤±æ•—: ' + error.message);
            }
        });
        
        // é¡¯ç¤ºæ¤ç‰©è©³æƒ…
        async function showPlantDetail(plantId) {
            currentPlantId = plantId;
            
            try {
                const response = await fetch(`/api/plants/${plantId}`);
                const data = await response.json();
                
                if (data.success) {
                    const plant = data.plant;
                    document.getElementById('detailPlantName').textContent = plant.chinese_name;
                    document.getElementById('detailScientificName').textContent = plant.scientific_name || '';
                    
                    // è¼‰å…¥ç…§ç‰‡
                    const photoGrid = document.getElementById('photoGrid');
                    const analyzeButtonContainer = document.getElementById('analyzeButtonContainer');
                    
                    if (data.photos && data.photos.length > 0) {
                        const currentPlantIdForDelete = plantId;  // ä¿å­˜ plantId ç”¨æ–¼åˆªé™¤åŠŸèƒ½
                        const photosWithoutAnalysis = data.photos.filter(photo => !photo.ai_analysis && !photo.care_suggestions);
                        
                        // å¦‚æœæœ‰æœªåˆ†æçš„ç…§ç‰‡ï¼Œé¡¯ç¤ºåˆ†ææŒ‰éˆ•
                        if (photosWithoutAnalysis.length > 0) {
                            analyzeButtonContainer.style.display = 'block';
                            updateSelectedCount();
                        } else {
                            analyzeButtonContainer.style.display = 'none';
                        }
                        
                        // ä¿å­˜ç…§ç‰‡åˆ—è¡¨ç”¨æ–¼ lightbox å°èˆª
                        window.currentPhotos = data.photos;
                        
                        photoGrid.innerHTML = data.photos.map((photo, index) => {
                            const filename = photo.photo_path.split(/[/\\]/).pop();
                            const hasAnalysis = photo.ai_analysis || photo.care_suggestions;
                            
                            // æ¸…ç†ç…§é¡§å»ºè­°æ–‡æœ¬ï¼Œç§»é™¤å¯èƒ½é‡è¤‡çš„å‰ç¶´
                            let cleanedSuggestions = '';
                            if (photo.care_suggestions) {
                                cleanedSuggestions = photo.care_suggestions.trim();
                                if (cleanedSuggestions.startsWith('ç…§é¡§å»ºè­°ï¼š')) {
                                    cleanedSuggestions = cleanedSuggestions.substring(5).trim();
                                } else if (cleanedSuggestions.startsWith('å»ºè­°ï¼š')) {
                                    cleanedSuggestions = cleanedSuggestions.substring(3).trim();
                                } else if (cleanedSuggestions.startsWith('å»ºè­°')) {
                                    cleanedSuggestions = cleanedSuggestions.substring(2).trim();
                                }
                            }
                            
                            const analysisHtml = hasAnalysis ? `
                                <div class="photo-analysis">
                                    ${photo.ai_analysis ? `
                                        <div class="photo-analysis-section">
                                            <div class="photo-analysis-title ai">ğŸ¤– AI åˆ†æ</div>
                                            <div class="photo-analysis-content">${escapeHtml(photo.ai_analysis)}</div>
                                        </div>
                                    ` : ''}
                                    ${cleanedSuggestions ? `
                                        <div class="photo-analysis-section">
                                            <div class="photo-analysis-title suggestion">ğŸ’¡ ç…§é¡§å»ºè­°</div>
                                            <div class="photo-analysis-content">${formatCareSuggestions(cleanedSuggestions)}</div>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : `
                                <div class="photo-analysis-pending">
                                    <span>â³</span>
                                    <span>AI åˆ†æä¸­æˆ–å°šæœªåˆ†æ</span>
                                </div>
                            `;
                            
                            const notesHtml = photo.notes ? `
                                <div class="photo-notes">
                                    <strong>ğŸ“ å‚™è¨»ï¼š</strong>${escapeHtml(photo.notes)}
                                </div>
                            ` : '';
                            
                            const takenAt = photo.taken_at ? new Date(photo.taken_at).toLocaleString('zh-TW', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            }) : '';
                            
                            const dateHtml = takenAt ? `
                                <div class="photo-date">
                                    <span>ğŸ“…</span>
                                    <span>${takenAt}</span>
                                </div>
                            ` : '';
                            
                            // å¦‚æœæ²’æœ‰AIåˆ†æï¼Œæ·»åŠ è¤‡é¸æ¡†
                            const checkboxHtml = !hasAnalysis ? `
                                <input type="checkbox" class="photo-checkbox" data-photo-id="${photo.id}" onchange="updateSelectedCount()" onclick="event.stopPropagation()">
                            ` : '';
                            
                            return `<div class="photo-item" data-photo-id="${photo.id}" data-photo-index="${index}">
                                <div class="photo-item-header" onclick="openLightbox(${index})">
                                    ${checkboxHtml}
                                    <button class="photo-delete-btn" onclick="event.stopPropagation(); deletePhoto(${photo.id}, ${currentPlantIdForDelete})" title="åˆªé™¤ç…§ç‰‡">Ã—</button>
                                    <img src="/uploads/${filename}" alt="ç…§ç‰‡" loading="lazy" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2Y1ZjVmNSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7lm77niYfliqDovb3lpLHotKU8L3RleHQ+PC9zdmc+';">
                                    <div class="photo-overlay">
                                        <span class="photo-overlay-icon">ğŸ”</span>
                                    </div>
                                </div>
                                ${dateHtml}
                                ${notesHtml}
                                ${analysisHtml}
                            </div>`;
                        }).join('');
                    } else {
                        photoGrid.innerHTML = `
                            <div class="empty-state" style="grid-column: 1 / -1;">
                                <div class="empty-state-icon">ğŸ“¸</div>
                                <div class="empty-state-text">é‚„æ²’æœ‰ç…§ç‰‡</div>
                                <div class="empty-state-hint">ä¸Šå‚³ç¬¬ä¸€å¼µç…§ç‰‡é–‹å§‹è¨˜éŒ„æ¤ç‰©æˆé•·æ­·ç¨‹</div>
                            </div>
                        `;
                        analyzeButtonContainer.style.display = 'none';
                    }
                    
                    document.getElementById('plantDetailModal').style.display = 'block';
                }
            } catch (error) {
                alert('è¼‰å…¥æ¤ç‰©è©³æƒ…å¤±æ•—: ' + error.message);
            }
        }
        
        // æ›´æ–°é¸ä¸­æ•¸é‡é¡¯ç¤º
        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.photo-checkbox:checked');
            const count = checkboxes.length;
            const countSpan = document.getElementById('selectedCount');
            if (countSpan) {
                if (count > 0) {
                    countSpan.textContent = `å·²é¸æ“‡ ${count} å¼µç…§ç‰‡`;
                    countSpan.style.color = '#2196F3';
                    countSpan.style.fontWeight = 'bold';
                } else {
                    countSpan.textContent = '';
                }
            }
        }
        
        // åˆ†æé¸ä¸­çš„ç…§ç‰‡
        async function analyzeSelectedPhotos() {
            const checkboxes = document.querySelectorAll('.photo-checkbox:checked');
            const photoIds = Array.from(checkboxes).map(cb => parseInt(cb.dataset.photoId));
            
            if (photoIds.length === 0) {
                alert('è«‹å…ˆé¸æ“‡è¦åˆ†æçš„ç…§ç‰‡');
                return;
            }
            
            if (!confirm(`ç¢ºå®šè¦åˆ†æ ${photoIds.length} å¼µç…§ç‰‡å—ï¼Ÿé€™å¯èƒ½éœ€è¦ä¸€äº›æ™‚é–“ã€‚`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/photos/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ photo_ids: photoIds })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`å·²é–‹å§‹åˆ†æ ${photoIds.length} å¼µç…§ç‰‡ï¼Œåˆ†æçµæœå°‡åœ¨å®Œæˆå¾Œè‡ªå‹•æ›´æ–°ã€‚`);
                    
                    // å–æ¶ˆé¸ä¸­æ‰€æœ‰è¤‡é¸æ¡†
                    checkboxes.forEach(cb => cb.checked = false);
                    updateSelectedCount();
                    
                    // ç­‰å¾…å¹¾ç§’å¾Œåˆ·æ–°é¡¯ç¤ºï¼ˆè®“ç”¨æˆ¶çœ‹åˆ°æ›´æ–°ï¼‰
                    setTimeout(() => {
                        if (currentPlantId) {
                            showPlantDetail(currentPlantId);
                        }
                    }, 3000);
                    
                    // å®šæœŸæª¢æŸ¥åˆ†æçµæœï¼ˆæ¯5ç§’æª¢æŸ¥ä¸€æ¬¡ï¼Œæœ€å¤šæª¢æŸ¥10æ¬¡ï¼‰
                    let checkCount = 0;
                    const checkInterval = setInterval(() => {
                        checkCount++;
                        if (currentPlantId) {
                            showPlantDetail(currentPlantId);
                        }
                        if (checkCount >= 10) {
                            clearInterval(checkInterval);
                        }
                    }, 5000);
                } else {
                    alert('é–‹å§‹åˆ†æå¤±æ•—: ' + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                alert('é–‹å§‹åˆ†æå¤±æ•—: ' + error.message);
            }
        }
        
        // åˆªé™¤ç…§ç‰‡
        async function deletePhoto(photoId, plantId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å¼µç…§ç‰‡å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/photos/${photoId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('ç…§ç‰‡å·²åˆªé™¤');
                    // é‡æ–°è¼‰å…¥æ¤ç‰©è©³æƒ…ä»¥æ›´æ–°ç…§ç‰‡åˆ—è¡¨
                    showPlantDetail(plantId);
                } else {
                    alert('åˆªé™¤å¤±æ•—: ' + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                alert('åˆªé™¤å¤±æ•—: ' + error.message);
            }
        }
        
        // ä¸Šå‚³ç…§ç‰‡
        async function uploadPhoto() {
            if (!currentPlantId) {
                alert('è«‹å…ˆé¸æ“‡æ¤ç‰©');
                return;
            }
            
            const fileInput = document.getElementById('plantPhoto');
            if (!fileInput.files || !fileInput.files[0]) {
                alert('è«‹é¸æ“‡ç…§ç‰‡');
                return;
            }
            
            const formData = new FormData();
            formData.append('photo', fileInput.files[0]);
            formData.append('notes', document.getElementById('photoNotes').value);
            
            try {
                const response = await fetch(`/api/plants/${currentPlantId}/photos`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('ç…§ç‰‡å·²ä¸Šå‚³ï¼');
                    fileInput.value = '';
                    document.getElementById('photoNotes').value = '';
                    showPlantDetail(currentPlantId);
                } else {
                    alert('ä¸Šå‚³å¤±æ•—: ' + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                alert('ä¸Šå‚³å¤±æ•—: ' + error.message);
            }
        }
        
        // ç…§ç‰‡æ”¾å¤§æŸ¥çœ‹åŠŸèƒ½
        let currentLightboxIndex = 0;
        
        function openLightbox(index) {
            if (!window.currentPhotos || window.currentPhotos.length === 0) return;
            
            currentLightboxIndex = index;
            const photo = window.currentPhotos[index];
            const filename = photo.photo_path.split(/[/\\]/).pop();
            const lightbox = document.getElementById('lightbox');
            const lightboxImage = document.getElementById('lightboxImage');
            
            lightboxImage.src = `/uploads/${filename}`;
            lightbox.classList.add('active');
            document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»¾å‹•
            
            // éµç›¤å°èˆª
            document.addEventListener('keydown', handleLightboxKeyboard);
        }
        
        function closeLightbox(event) {
            if (event && event.target !== event.currentTarget && event.target.closest('.lightbox-content')) {
                return; // é»æ“Šåœ–ç‰‡æœ¬èº«ä¸é—œé–‰
            }
            
            const lightbox = document.getElementById('lightbox');
            lightbox.classList.remove('active');
            document.body.style.overflow = ''; // æ¢å¾©æ»¾å‹•
            document.removeEventListener('keydown', handleLightboxKeyboard);
        }
        
        function changeLightboxPhoto(direction, event) {
            if (event) event.stopPropagation();
            
            if (!window.currentPhotos || window.currentPhotos.length === 0) return;
            
            currentLightboxIndex += direction;
            
            if (currentLightboxIndex < 0) {
                currentLightboxIndex = window.currentPhotos.length - 1;
            } else if (currentLightboxIndex >= window.currentPhotos.length) {
                currentLightboxIndex = 0;
            }
            
            const photo = window.currentPhotos[currentLightboxIndex];
            const filename = photo.photo_path.split(/[/\\]/).pop();
            const lightboxImage = document.getElementById('lightboxImage');
            lightboxImage.src = `/uploads/${filename}`;
        }
        
        function handleLightboxKeyboard(event) {
            if (event.key === 'Escape') {
                closeLightbox();
            } else if (event.key === 'ArrowLeft') {
                changeLightboxPhoto(-1, event);
            } else if (event.key === 'ArrowRight') {
                changeLightboxPhoto(1, event);
            }
        }
        
        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            const modals = document.getElementsByClassName('modal');
            for (let modal of modals) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            }
        }
        
        // é é¢è¼‰å…¥æ™‚è¼‰å…¥æ¤ç‰©åˆ—è¡¨
        loadPlants();
    </script>
</body>
</html>

